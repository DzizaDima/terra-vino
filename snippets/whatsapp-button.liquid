{%- liquid
  comment
    WhatsApp floating button snippet

    Parameters:
    - enabled: boolean (optional, default: settings.whatsapp_enabled)
    - number: string (optional, default: settings.whatsapp_number)
    - message: string (optional, default: settings.whatsapp_message)
    - position: string (optional, default: settings.whatsapp_position)
    - size: number (optional, default: settings.whatsapp_size)
  endcomment

  assign whatsapp_enabled = enabled | default: settings.whatsapp_enabled
  assign whatsapp_number = number | default: settings.whatsapp_number
  assign whatsapp_message = message | default: settings.whatsapp_message
  assign whatsapp_position = position | default: settings.whatsapp_position
  assign whatsapp_size = size | default: settings.whatsapp_size

  comment
    Only proceed if WhatsApp is enabled AND a valid number is provided
  endcomment
  if whatsapp_enabled and whatsapp_number != blank and whatsapp_number != '+1234567890'
    assign clean_number = whatsapp_number | replace: '+', '' | replace: ' ', '' | replace: '-', '' | replace: '(', '' | replace: ')', ''
    assign whatsapp_url = 'https://wa.me/' | append: clean_number
    if whatsapp_message != blank
      assign encoded_message = whatsapp_message | url_encode
      assign whatsapp_url = whatsapp_url | append: '?text=' | append: encoded_message
    endif
  endif
-%}

{%- if whatsapp_enabled and whatsapp_number != blank and whatsapp_number != '+1234567890' and whatsapp_url != blank -%}
  <div class="whatsapp-button whatsapp-button--{{ whatsapp_position }}" style="--whatsapp-size: {{ whatsapp_size }}px;">
    <script>
      // WhatsApp button click handler
      document.addEventListener('DOMContentLoaded', function () {
        const whatsappButton = document.querySelector('.whatsapp-button__link');

        if (whatsappButton) {
          // Handle click events
          whatsappButton.addEventListener('click', handleWhatsAppClick);

          // Handle keyboard events (Enter and Space)
          whatsappButton.addEventListener('keydown', function (e) {
            if (e.key === 'Enter' || e.key === ' ') {
              e.preventDefault();
              handleWhatsAppClick.call(this, e);
            }
          });

          function handleWhatsAppClick(e) {
            e.preventDefault();

            const whatsappUrl = this.getAttribute('data-whatsapp-url');

            // Check if URL exists and is valid
            if (!whatsappUrl) {
              console.error('WhatsApp URL is empty. Please check your WhatsApp settings in Theme Customizer.');
              alert('WhatsApp is not properly configured. Please contact the site administrator.');
              return;
            }

            if (whatsappUrl && whatsappUrl.startsWith('https://wa.me/')) {
              // Open WhatsApp in new tab/window
              window.open(whatsappUrl, '_blank', 'noopener,noreferrer');

              // Optional: Track the click event
              if (typeof gtag !== 'undefined') {
                gtag('event', 'click', {
                  event_category: 'WhatsApp',
                  event_label: 'Contact Button',
                });
              }
            } else {
              console.error('Invalid WhatsApp URL:', whatsappUrl);
              console.error('Expected URL format: https://wa.me/[number]');
              console.error('Please check WhatsApp settings in Theme Customizer:');
              console.error('1. Go to Shopify Admin → Online Store → Themes → Customize');
              console.error('2. Click Theme Settings');
              console.error('3. Find "WhatsApp Button" section');
              console.error('4. Enter a valid phone number with country code (e.g., +1234567890)');
            }
          }
        }
      });
    </script>
    <button
      type="button"
      class="whatsapp-button__link"
      aria-label="{{ 'general.whatsapp.contact_us' | t }}"
      data-whatsapp-url="{{ whatsapp_url }}"
    >
      <svg class="whatsapp-button__icon" viewBox="0 0 24 24" fill="currentColor">
        <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893A11.821 11.821 0 0020.885 3.488"/>
      </svg>
    </button>
  </div>

  {%- style -%}
    .whatsapp-button {
      position: fixed;
      z-index: 1000;
      bottom: 20px;
      right: 20px;
      width: var(--whatsapp-size);
      height: var(--whatsapp-size);
      border-radius: 50%;
      background-color: #25d366;
      box-shadow: 0 4px 12px rgba(37, 211, 102, 0.4);
      transition: all 0.3s ease;
      animation: whatsapp-pulse 2s infinite;
    }

    .whatsapp-button--bottom-left {
      right: auto;
      left: 20px;
    }

    .whatsapp-button:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 20px rgba(37, 211, 102, 0.6);
    }

    .whatsapp-button__link {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      height: 100%;
      border: none;
      background: none;
      border-radius: 50%;
      cursor: pointer;
      padding: 0;
      margin: 0;
      outline: none;
      transition: all 0.3s ease;
    }

    .whatsapp-button__link:focus {
      outline: 2px solid rgba(255, 255, 255, 0.5);
      outline-offset: 2px;
    }

    .whatsapp-button__link:active {
      transform: scale(0.95);
    }

    .whatsapp-button__icon {
      width: 60%;
      height: 60%;
      fill: white;
    }

    @keyframes whatsapp-pulse {
      0% {
        box-shadow: 0 4px 12px rgba(37, 211, 102, 0.4);
      }
      50% {
        box-shadow: 0 4px 12px rgba(37, 211, 102, 0.4), 0 0 0 10px rgba(37, 211, 102, 0.1);
      }
      100% {
        box-shadow: 0 4px 12px rgba(37, 211, 102, 0.4);
      }
    }

    @media screen and (max-width: 749px) {
      .whatsapp-button {
        bottom: 15px;
        right: 15px;
        width: calc(var(--whatsapp-size) * 0.9);
        height: calc(var(--whatsapp-size) * 0.9);
      }

      .whatsapp-button--bottom-left {
        right: auto;
        left: 15px;
      }
    }
  {%- endstyle -%}
{%- endif -%}
